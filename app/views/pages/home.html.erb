<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

<h1>Memholes
<span class='float-right'><% if user_signed_in? %>
Welcome, <%= current_user.first_name %> - My Pins <%= link_to 'Sign Out', destroy_user_session_path, method: :delete, class: 'btn btn-outline-primary'%>
<% else %>
<%= link_to 'Sign In', new_user_session_path, class: 'btn btn-outline-primary'%>
<% end %></span></h1>
<div class='container'>
<div id="map" style="height: 60vh;"></div>
<script> // display map
	var thatVerified = new L.LayerGroup(); //layer for verified potholes
	var notVerified = new L.LayerGroup();  //layer for unverified potholes
	var fixedP = new L.LayerGroup();

	var mymap = L.map('map',{
    center: [35.1495, -89.97],
    zoom: 11,
	layers:[thatVerified]  //only verified potholes is displayed by default
    });

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);


</script>

<script>// custom pothole pin
	var LeafIcon = L.Icon.extend({
			options: {
				iconSize:     [17, 22],
				iconAnchor:   [8, 21],
				popupAnchor:  [1, -10] //0,0 is at base of pin
			}
	});
	var redIcon = new LeafIcon({iconUrl: '<%= image_url('verified.png')%>'}),
		yellowIcon = new LeafIcon({iconUrl: '<%= image_url('unverified.png')%>'}),
		greenIcon = new LeafIcon({iconUrl: '<%= image_url('fixed.png')%>'});

</script>

<% if user_signed_in? %>
<script>
<% User.find_by(id: current_user.id).pins.each do |pothole| %>
<%if pothole.fixed==true%>  // check to see if pot hole is verified
	L.marker([<%= pothole.lat %>, <%= pothole.lon %>], {icon: greenIcon}) // by default: draggable => false, clickable =>true. not needed
	.bindPopup('<b>Rate</b> "'+'<b><%=pothole.name%></b>'+'" <b>from 1-10</b>'+'<br>'+' Current rating: '+'<%=pothole.rating%>'+
	'<%= form_with url: edit_pothole2_path(pothole.id) do |form| %>'
	+'<div class ="field">'
	+'<%= form.text_field :rating, class: 'form-control' %>'
	+'</div>'
	+'<div class="action">'
	+'<%= form.submit 'Submit Rating', class: 'btn btn-primary'%>'
	+'</div>'
	+'<% end %>'//form end
	).addTo(fixedP);
	<%end%>
<%if pothole.verified==true && pothole.fixed==false%>  // check to see if pot hole is verified
	L.marker([<%= pothole.lat %>, <%= pothole.lon %>], {icon: redIcon})
	.bindPopup('<b>Rate</b> "'+'<b><%=pothole.name%></b>'+'" <b>from 1-10</b>'+'<br>'+' Current rating: '+'<%=pothole.rating%>'+
	'<%= form_with url: edit_pothole2_path(pothole.id) do |form| %>'
	+'<div class ="field">'
	+'<%= form.text_field :rating, class: 'form-control' %>'
	+'</div>'
	+'<div class="action">'
	+'<%= form.submit 'Submit Rating', class: 'btn btn-primary'%>'
	+'</div>'
	+'<% end %>'//form end
	).addTo(thatVerified);
<%else if pothole.verified==false && pothole.fixed==false%>
L.marker([<%= pothole.lat %>, <%= pothole.lon %>], {icon: yellowIcon})
	.bindPopup('<b>Rate</b> "'+'<b><%=pothole.name%></b>'+'" <b>from 1-10</b>'+'<br>'+' Current rating: '+'<%=pothole.rating%>'+
	'<%= form_with url: edit_pothole2_path(pothole.id) do |form| %>'
	+'<div class ="field">'
	+'<%= form.text_field :rating, class: 'form-control' %>'
	+'</div>'
	+'<div class="action">'
	+'<%= form.submit 'Submit Rating', class: 'btn btn-primary'%>'
	+'</div>'
	+'<% end %>'//form end
	).addTo(notVerified);
<%end%> //if end
<%end%> // else if end

<%end%>// end loop

	var overlays = {
		"Verified Potholes": thatVerified,
		"Not Verified": notVerified,
		"Fixed": fixedP
		};

	L.control.layers(null,overlays,{collapsed:false}).addTo(mymap);

</script>
<script>

	var popup = L.popup();
	function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent(
			'<%= form_with url: new_pothole_path do |form| %>'
			+'<div class ="field">'
			+'<%= form.hidden_field :user_id, class: 'form-control', value: current_user.id, readonly: true %>'
			+'</div>'
			+'<div class ="field">'
			+'<%= form.label :name %>'
			+'<%= form.text_field :name, class: 'form-control' %>'
			+'</div>'
			+'<div class ="field">'
			+'<%= form.label :latitude %>'
			+'<%= form.text_field :lat, class: 'form-control' %>'
			+'</div>'
			+'<div class ="field">'
			+'<%= form.label :longitude %>'
			+'<%= form.text_field :lon, class: 'form-control' %>'
			+'</div>'
			+'<div class="action">'
			+'<%= form.submit 'Submit pothole', class: 'btn btn-primary'%>'
			+'</div>'
			+'<% end %>')
			.openOn(mymap);
		document.getElementById("lat").value = e.latlng.lat;
		document.getElementById("lon").value = e.latlng.lng;
		
	}
	mymap.on('click', onMapClick);
		

</script>

<div id="table-wrap">
<div id="table-scroll" style="max-height: 60vh; overflow: auto;">
<table class="table table-sm" style="table-layout: auto;">
	<thead>
		<tr>
			<th scope="col">ID</th>
			<th scope="col">Name</th>
			<th scope="col">Rating</th>
			<th scope="col">Lat</th>
			<th scope="col">Lon</th>
			<th scope="col">User</th>
			<th scope="col"></th>
		</tr>
	</thead>
	<tbody style="">
	<% User.find_by(id: current_user.id).pins.each do |pothole| %>
		<tr>
			<td><%= pothole.id %></td>
			<td><%= pothole.name %></td>
			<td><%= pothole.rating %></td>
			<td><%= pothole.lat %></td>
			<td><%= pothole.lon %></td>
			<td><%= pothole.user.first_name%></td>
			<td><%= link_to 'View/Edit', pothole_path(pothole) %></td>
		</tr>
	<% end %>
	</tbody>
</table>
</div>
</div>


<div class = 'container'>
<div id="newform">
<%= render '/potholes/form_new' %>
</div>
</div>

<% else %>
<script> //display all pin for non-member
<% @pothole.each do |pothole| %>
	<%if pothole.fixed == true %>
	L.marker([<%= pothole.lat %>, <%= pothole.lon %>],{icon: greenIcon}).bindPopup("Name: <%= pothole.name %><p>Rating: <%= pothole.rating %></p>").addTo(fixedP);
	<%end%>
	<% if pothole.verified == true && pothole.fixed == false %>  // check to see if pot hole is verified
		L.marker([<%= pothole.lat %>, <%= pothole.lon %>],{icon: redIcon}).bindPopup("Name: <%= pothole.name %><p>Rating: <%= pothole.rating %></p>").addTo(thatVerified);
	<%else if pothole.verified == false && pothole.fixed == false%>
		L.marker([<%= pothole.lat %>, <%= pothole.lon %>], {icon: yellowIcon}).bindPopup("Name: <%= pothole.name %><p>Rating: <%= pothole.rating %></p>").addTo(notVerified);
	<%end%>
	<%end%>

<%end%>


var overlays = {  // add filter to map
	"Verified Potholes": thatVerified,
	"Not Verified": notVerified,
	"Fixed": fixedP
	};

L.control.layers(null,overlays,{collapsed:false}).addTo(mymap);



</script>




<div id="table-wrap">
<div id="table-scroll" style="max-height: 60vh; overflow: auto;">
<table class="table table-sm" style="table-layout: auto;">
	<thead>
		<tr>
			<th scope="col">ID</th>
			<th scope="col">Name</th>
			<th scope="col">Rating</th>
			<th scope="col">Lat</th>
			<th scope="col">Lon</th>
			<th scope="col">User</th>
			<th scope="col"></th>
		</tr>
	</thead>
	<tbody style="">
	<% @pothole.each do |pothole| %>
		<tr>
			<td><%= pothole.id %></td>
			<td><%= pothole.name %></td>
			<td><%= pothole.rating %></td>
			<td><%= pothole.lat %></td>
			<td><%= pothole.lon %></td>
			<td><%= pothole.user.first_name%></td>
			<td><%= link_to 'View', pothole_path(pothole) %></td>
		</tr>
	<% end %>
	</tbody>
</table>
</div>
</div>
<div class = 'container'>
<div id="newform">
<%= render "/potholes/newuser" %>
</div>
</div>
<% end %>
</div>
